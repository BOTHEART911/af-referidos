<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Referidos</title>
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp">
  <meta name="theme-color" content="#007BFF" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    body, html {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100%;
      min-height: 100vh;
      background-color: #f3f4f6;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .container, main.container {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.05);
    }
    .titulo-contenedor h1, .titulo-contenedor, h1.titulo-animado {
      font-size: 2rem;
      font-weight: bold;
      color: green;
      text-shadow: 3px 3px 3px #031732;
      animation: rotate 5s infinite linear, stay 10s infinite;
    }
    @keyframes rotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
    @keyframes stay { 0%, 25% { transform: rotateY(0deg);} 50%, 75% { transform: rotateY(0deg);} 100% { transform: rotateY(360deg);} }
    .image-container img { max-width: 220px; border-radius: 2px; }
    .copyright { font-size: 0.85em; color: #666; margin-top: 4px; text-align: center; }
    #contactosForm {
      margin: 30px auto 0 auto; max-width: 400px; background: rgba(255,255,255,0.97);
      border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.2); padding: 24px 16px 10px 16px; display: block;
      transition: opacity .25s ease, transform .25s ease;
    }
    #contactosForm label { font-weight: bold; color: #1257b7; }
    .boton-efecto {
      background: linear-gradient(90deg, #1257b7, #3ea652); color: white; border: none; padding: 8px 16px; border-radius: 7px;
      font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; box-shadow: 1px 2px 4px #ccc;
    }
    .boton-efecto:hover { background: linear-gradient(90deg, #3ea652, #1257b7); }
    .error { color: red; margin-bottom: 8px; text-align: center; font-weight: bold; }
    #tituloLider {
      margin: 20px 0 5px 0; font-size: 1.5em; color: #155724; font-weight: bold; text-align: center; letter-spacing: 1px; text-shadow: 1px 1px 1px #b7e0c3;
    }
    #tablaReferidos th, #tablaReferidos td, #tablaReferidos thead th, #tablaReferidos tfoot th {
      text-align: center !important; vertical-align: middle !important;
    }
    #tablaReferidos { width: 100% !important; background: rgba(255,255,255,0.98); border-radius: 10px; margin-top: 20px; }
    .btn-votacion { background-color: #e74c3c !important; color: white !important; border-radius: 6px !important; font-weight: bold; font-size: 1em; padding: 3px 10px !important; margin-right: 3px; }
    .btn-votacion.verde { background-color: #27ae60 !important; }
    .btn-whatsapp { background: #25D366 !important; color: white !important; border-radius: 6px !important; font-size: 1.15em !important; padding: 3px 10px !important; margin-left: 3px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-whatsapp i { font-size: 1.3em !important; color: white !important; vertical-align: middle; }
    .resaltado-cambio { background: #fff6b2 !important; transition: background 1.6s; }
    .table-responsive { overflow-x: auto; }
    .modal-content { border-radius: 12px; }
    .swal2-popup.swal2-responsive-popup { width: 350px !important; max-width: 95vw; font-size: 15px !important; }
    .btn-votacion.azul { background-color: #007BFF !important; }
    .btn-votacion.gris { background-color: #6c757d !important; color: #fff !important; }
    .btn-votacion.naranja { background-color: #f39c12 !important; color: #fff !important; }

    #tituloLider { color: #007bff !important; font-weight: bold; font-size: 1.6em; text-align: left; margin: 20px 0 5px 0; letter-spacing: 1px; text-shadow: none !important; }

    .titulo-contenedor { perspective: 1200px; text-align: center; }
    .titulo-animado { font-size: 2rem; font-weight: bold; color: #007BFF; text-shadow: 3px 3px 3px #031732; animation: rotate 5s infinite linear, stay 10s infinite; }

    #contactosForm { box-shadow: 0 0 16px rgba(0,0,0,0.23); position: relative; }
    #contactosForm .titulo-contenedor h1, #contactosForm .titulo-contenedor h1.titulo-animado {
      color: #007bff !important; text-shadow: none !important; font-size: 2.2rem; letter-spacing: 1px; margin-bottom: 4px; font-weight: bold; text-align: center; animation: none;
    }
    #contactosForm > p:first-of-type { color: #666 !important; text-align: center !important; font-size: 13px !important; margin-top: 0; margin-bottom: 16px; }
    #contactosForm label[for="documento"] { display: block; color: #007bff !important; font-weight: bold; font-size: 1.11em; margin-bottom: 2px; margin-top: 10px; }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
      will-change: opacity;
    }
    .loader.hidden{
      display:flex !important;
      opacity:0; pointer-events:none;
    }
    .spinner-ios{
      position:relative; width:64px; height:64px;
    }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{
      0%, 39%, 100% { opacity:.2; }
      40% { opacity:1; }
    }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    #contactosForm input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 1em;
      margin-bottom: 10px;
      margin-top: 1px;
    }
    .input-pass-group { position: relative; width: 100%; }
    .input-pass-group input { width: 100%; padding-right: 42px; }
    .input-pass-group .toggle-pass {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent;
      padding: 4px;
      cursor: pointer;
      line-height: 0;
      color: #007bff;
    }
    .input-pass-group .toggle-pass:focus-visible {
      outline: 2px solid #80bdff;
      border-radius: 4px;
    }
    #contactosForm #btn-iniciar-sesion {
      display: block;
      width: max-content;
      margin: 8px auto 12px;
      padding: 10px 22px;
      font-weight: 800;
      font-size: 1.15rem;
      letter-spacing: .3px;
      border-radius: 8px;
    }
    #contactosForm .btn-center{
      display: flex;
      justify-content: center;
    }
    .btn-icon-db{ background:transparent; border:0; padding:4px; margin-left:8px; vertical-align:middle; cursor:pointer; color:#c0392b; }
    .btn-icon-db svg{ width:16px; height:16px; display:inline-block; vertical-align:middle; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <!-- Formulario de acceso -->
  <form id="contactosForm">
    <div class="titulo-contenedor">
      <h1 class="titulo-animado">INGRESO ADMINISTRADOR</h1>
    </div>
    <p style="color: grey; text-align: justify; font-size: 13px;">
      <b>Este Portal es de uso Exclusivo del Administrador.</b><br>
      <i>Equipo del Hacer</i>
    </p>
    <label for="documento"><big><b>Clave de acceso:</b></big></label>
    <div class="input-pass-group">
      <input
        type="password"
        id="documento"
        name="documento"
        placeholder="Ingresa la clave"
        required
        autocomplete="off"
      />
      <button type="button" id="toggleDocumento" class="toggle-pass" aria-label="Mostrar/Ocultar clave" aria-controls="documento" aria-pressed="false" title="Mostrar/Ocultar">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
          <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/>
          <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/>
        </svg>
      </button>
    </div>
    <div id="errorMensaje" class="error"></div>
    <div class="btn-center">
      <button type="button" class="boton-efecto" id="btn-iniciar-sesion" onclick="validarDocumento()">
        Iniciar Sesión
      </button>
    </div>
    <div class="copyright">
      Copyright © <br>
      <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polanía</b></a>
    </div>
  </form>

  <!-- Contenedor de la tabla -->
  <main class="container mt-3" id="mainTableContainer" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:10px; margin-bottom: 0;">
      <div id="tituloLider"></div>
      <div style="display: flex; align-items: center;">
        <div class="header-right" style="display:flex; flex-direction:column; align-items:flex-end; margin-right:12px;">
          <div class="copyright" style="font-size:0.65em;">
            Copyright © <a href="https://wa.me/573103230712" target="_blank"><b>OSCAR POLANIA</b></a>
          </div>
          <button class="boton-efecto" id="btn-cerrar-sesion" onclick="cerrarSesion()" style="background:#C0392B; color:#fff;">Cerrar Sesión</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tablaReferidos" class="table table-striped responsive">
        <thead></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </main>

  <!-- Modal Votación (igual que tenías) -->
  <!-- ... (conservo todo tu HTML de modales y scripts tal cual, solo cambian las llamadas a la API) ... -->

  <!-- JS y dependencias -->
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    // URL del Web App
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzOZfjaBk5PF-0ytQ0pmE1EL4e8EzhLTAhURFjAqFMJbd3NJS1K1IHtpLgAzhxP09hv/exec'; // reemplaza por la URL de despliegue actual

    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
        loader.classList.add('hidden');
      }
    }

    // API adaptada al nuevo backend
    async function apiGetTodasFilas() {
      startLoading();
      try{
        const body = new URLSearchParams({ action: 'getTodasFilas' });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    async function apiGuardarVotacion(payload) {
      startLoading();
      try{
        const body = new URLSearchParams({
          action: 'guardarVotacion',
          idxFila: payload.idxFila != null ? String(payload.idxFila) : '',
          nuip: payload.nuip,
          departamento: payload.departamento,
          municipio: payload.municipio,
          puesto: payload.puesto,
          direccion: payload.direccion,
          mesa: payload.mesa
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j;
      } finally { stopLoading(); }
    }

    async function apiEliminarFilas(nuips) {
      startLoading();
      try{
        const body = new URLSearchParams({
          action: 'eliminarFilas',
          nuips: JSON.stringify(nuips || [])
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j;
      } finally { stopLoading(); }
    }

    let filasFiltradas = [];
    let encabezados = [];
    let tabla;
    let selectedNuips = new Set();
    let deleteMode = false;
    let filaVotacion = null;
    let filaWhatsapp = null;

    // Columnas a ocultar por defecto (no depende de residencia D ni estado O)
    const columnasOcultas = ["CONTACTO", "REFERENCIA", "LIDER", "DEPARTAMENTO", "PUESTO", "DIRECCION", "MESA", "AÑO", "MES", "DIA"];

    async function validarDocumento() {
      const clave = document.getElementById('documento').value.trim();
      if (!clave){
        Swal.fire({ icon:'warning', title:'Clave requerida', text:'Ingresa la clave de acceso.' });
        return;
      }
      if (clave !== '202402028'){
        Swal.fire({ icon:'error', title:'Clave incorrecta', text:'Verifica la clave e inténtalo de nuevo.' });
        return;
      }

      playSoundOnce(SOUNDS.login);

      Swal.fire({
        title: 'Cargando datos...',
        html: 'Por favor espera unos segundos.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try{
        const res = await apiGetTodasFilas();
        Swal.close();

        encabezados = res.encabezados || [];
        filasFiltradas = Array.isArray(res.filas) ? res.filas : [];

        document.getElementById('tituloLider').textContent = 'Administrador';

        ocultarFormulario();
        inicializarTabla();
      } catch(e){
        Swal.close();
        Swal.fire({ icon:'error', title:'Error', text:String(e) });
      }
    }

    function mostrarFormulario() {
      document.getElementById('contactosForm').style.display = 'block';
      document.getElementById('mainTableContainer').style.display = 'none';
      document.getElementById('tituloLider').textContent = "";
    }
    function ocultarFormulario() {
      document.getElementById('contactosForm').style.display = 'none';
      document.getElementById('mainTableContainer').style.display = 'block';
    }
    function cerrarSesion() {
      playSoundOnce(SOUNDS.logout);
      filasFiltradas = [];
      encabezados = [];
      if (tabla) { tabla.destroy(); }
      mostrarFormulario();
      document.getElementById('documento').value = "";
    }

    function inicializarTabla() {
      let colsDT = encabezados.map(h => ({ title: h }));
      colsDT.push({ title: "Votación" });
      colsDT.push({ title: "WhatsApp" });
      colsDT.push({ title: "Seleccionar" });

      $("#tablaReferidos thead").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");
      $("#tablaReferidos tfoot").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");

      let data = filasFiltradas.map(row => [...row, "", "", ""]).reverse();

      if ($.fn.DataTable.isDataTable('#tablaReferidos')) {
        $('#tablaReferidos').DataTable().destroy();
        $('#tablaReferidos').empty();
      }

      const ocultarIdxs = columnasOcultas
        .map(col => encabezados.indexOf(col))
        .filter(idx=>idx>-1);

      const colvisButton = { extend: 'colvis', text: 'Filtrar Columnas' };
      const buttonsArr = [
        { extend: 'copy',  text: '<i class="bi bi-clipboard-fill"></i>', className: 'btn btn-secondary', exportOptions: { columns: ':visible' }, title: 'Referidos Administrador' },
        { extend: 'excel', text: '<i class="bi bi-file-earmark-excel-fill"></i>', className: 'btn btn-success',  exportOptions: { columns: ':visible' }, filename: 'Referidos Administrador', title: 'Referidos Administrador' },
        { extend: 'pdf',   text: '<i class="bi bi-file-earmark-pdf-fill"></i>',   className: 'btn btn-danger',   exportOptions: { columns: ':visible' }, filename: 'Referidos Administrador', title: 'Referidos Administrador' },
        { extend: 'print', text: '<i class="bi bi-printer-fill"></i>',            className: 'btn btn-info',     exportOptions: { columns: ':visible' }, title: 'Referidos Administrador' },
        colvisButton
      ];

      const idxVotacion = colsDT.length - 3;
      const idxWhatsapp = colsDT.length - 2;
      const idxSeleccion = colsDT.length - 1;

      tabla = $('#tablaReferidos').DataTable({
        language: { url: "//cdn.datatables.net/plug-ins/2.3.2/i18n/es-CO.json" },
        responsive: false,
        dom: 'Blfrtip',
        scrollX: true,
        autoWidth: true,
        pagingType: 'full_numbers',
        lengthMenu: [5, 10, 20, 50, 100],
        columns: colsDT,
        data: data,
        order: [],
        buttons: buttonsArr,
        columnDefs: [
          ...ocultarIdxs.map(idx => ({ targets: idx, visible: false })),
          {
            targets: idxVotacion,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              var idxMunicipio = encabezados.indexOf("MUNICIPIO");
              var municipio = "";
              if (idxMunicipio > -1) {
                municipio = (row[idxMunicipio] || "").toString().trim().toUpperCase();
              }
              var colorClass =
                municipio === "A LA ESPERA"   ? "gris"    :
                municipio === "POR CONFIRMAR" ? "naranja" :
                municipio === "SIN CONSULTAR" ? "azul"    :
                municipio === "FLANDES"       ? "verde"   : "";

              return `<button class="btn-votacion${colorClass ? ' ' + colorClass : ''}" data-row="${meta.row}" onclick="abrirModalVotacion(${meta.row})">Votación</button>`;
            }
          },
          {
            targets: idxWhatsapp,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const whatsappBtn = `<button class="btn-whatsapp" data-row="${meta.row}" onclick="abrirModalWhatsapp(${meta.row})"><i class="bi bi-whatsapp"></i></button>`;
              const copyIcon = `<button type="button" class="btn-icon-db" title="Copiar novedades" onclick="copiarFilaInfo(${meta.row})" aria-label="Copiar novedades">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database-fill-exclamation" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path d="M8 1c-1.573 0-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4s.875 1.755 1.904 2.223C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777C13.125 5.755 14 5.007 14 4s-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1"/>
        <path d="M2 7v-.839c.457.432 1.004.751 1.49.972C4.722 7.693 6.318 8 8 8s3.278-.307 4.51-.867c.486-.22 1.033-.54 1.49-.972V7c0 .424-.155.802-.411 1.133a4.51 4.51 0 0 0-4.815 1.843A12 12 0 0 1 8 10c-1.573 0-3.022-.289-4.096-.777C2.875 8.755 2 8.007 2 7m6.257 3.998L8 11c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V10c0 1.007.875 1.755 1.904 2.223C4.978 12.711 6.427 13 8 13h.027a4.55 4.55 0 0 1 .23-2.002m-.002 3L8 14c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V13c0 1.007.875 1.755 1.904 2.223C4.978 15.711 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-1.3-1.905"/>
        <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-3.5-2a.5.5 0 0 0-.5.5v1.5a.5.5 0 0 0 1 0V11a.5.5 0 0 0-.5-.5m0 4a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
      </svg>
    </button>`;
              return whatsappBtn + copyIcon;
            }
          },
          {
            targets: idxSeleccion,
            orderable: false,
            searchable: false,
            visible: true,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const nuip = (row && row[0] != null) ? String(row[0]) : '';
              const checked = selectedNuips.has(nuip) ? 'checked' : '';
              return `<input type="checkbox" class="form-check-input row-select" data-nuip="${nuip}" ${checked} />`;
            }
          }
        ]
      });

      $('#tablaReferidos').on('change', 'input.row-select', function() {
        const nuip = String(this.dataset.nuip || '');
        if (!nuip) return;
        if (this.checked) selectedNuips.add(nuip);
        else selectedNuips.delete(nuip);
      });
    }

    // Aquí mantienes todas tus funciones: abrirModalVotacion, guardar votación, abrirModalWhatsapp, copiarFilaInfo, etc.
    // Solo asegúrate de que cuando llamen al backend usen apiGuardarVotacion y apiEliminarFilas definidos arriba.

    // Toggle ver/ocultar clave
    (function(){
      const input = document.getElementById('documento');
      const btn = document.getElementById('toggleDocumento');
      const ICON_EYE_SLASH = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
  <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/>
  <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/>
</svg>`;
      const ICON_EYE = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
  <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
  <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
</svg>`;

      if (input && btn){
        btn.addEventListener('click', function(){
          const willShow = input.type === 'password';
          input.type = willShow ? 'text' : 'password';
          btn.setAttribute('aria-pressed', String(willShow));
          btn.innerHTML = willShow ? ICON_EYE : ICON_EYE_SLASH;
          try {
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
          } catch(e){}
        });
      }
    })();

    document.getElementById('btn-iniciar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.login));
    document.getElementById('btn-cerrar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.logout));
  </script>
</body>
</html>
