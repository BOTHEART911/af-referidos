<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>ANALISIS DE REFERIDOS</title>
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" type="image/png">
  <meta name="theme-color" content="#007BFF" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    body, html {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100%;
      min-height: 100vh;
      background-color: #f3f4f6; /* fondo liso */
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .container, main.container {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.05);
    }

    .titulo-contenedor { perspective: 1200px; text-align: center; }
    .titulo-animado {
      font-size: 2rem;
      font-weight: bold;
      color: #007BFF;
      text-shadow: 3px 3px 3px #031732;
      animation: rotate 5s infinite linear, stay 10s infinite;
    }
    @keyframes rotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
    @keyframes stay { 0%, 25% { transform: rotateY(0deg);} 50%, 75% { transform: rotateY(0deg);} 100% { transform: rotateY(360deg);} }

    .copyright { font-size: 0.85em; color: #666; margin-top: 4px; text-align: center; }

    #contactosForm {
      margin: 30px auto 0 auto;
      max-width: 400px;
      background: rgba(255,255,255,0.97);
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      padding: 24px 16px 10px 16px;
      display: block;
      transition: opacity .25s ease, transform .25s ease;
    }
    #contactosForm label { font-weight: bold; color: #1257b7; }
    #contactosForm > p:first-of-type {
      color: #666 !important;
      text-align: center !important;
      font-size: 13px !important;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .boton-efecto {
      width: 100%;
      margin: 0 auto 12px auto;
      display: block;
      background: #fff !important;
      color: #222 !important;
      border: 2px solid #007bff;
      border-radius: 7px;
      font-size: 1.13em;
      font-weight: bold;
      box-shadow: 0 2px 8px #b9c7e0;
      transition: background 0.2s, color 0.2s, border 0.2s;
      padding: 10px 0;
      text-align: center;
      letter-spacing: 0.5px;
    }
    .boton-efecto:hover {
      background: #007bff !important;
      color: #fff !important;
      border-color: #007bff;
    }

    .error { color: red; margin-bottom: 8px; text-align: center; font-weight: bold; }

    #tituloLider {
      margin: 20px 0 5px 0;
      font-size: 1.6em;
      color: #007bff !important;
      font-weight: bold;
      text-align: left;
      letter-spacing: 1px;
      text-shadow: none !important;
    }

    #tablaReferidos th, #tablaReferidos td, #tablaReferidos thead th, #tablaReferidos tfoot th {
      text-align: center !important;
      vertical-align: middle !important;
    }
    #tablaReferidos {
      width: 100% !important;
      background: rgba(255,255,255,0.98);
      border-radius: 10px;
      margin-top: 20px;
    }

    .btn-votacion {
      background-color: #e74c3c !important;
      color: white !important;
      border-radius: 6px !important;
      font-weight: bold;
      font-size: 1em;
      padding: 3px 10px !important;
      margin-right: 3px;
    }
    .btn-votacion.verde { background-color: #27ae60 !important; }
    .btn-votacion.azul { background-color: #007BFF !important; }
    .btn-votacion.gris { background-color: #6c757d !important; color: #fff !important; }
    .btn-votacion.naranja { background-color: #f39c12 !important; color: #fff !important; }

    .btn-whatsapp {
      background: #25D366 !important;
      color: white !important;
      border-radius: 6px !important;
      font-size: 1.15em !important;
      padding: 3px 10px !important;
      margin-left: 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-whatsapp i { font-size: 1.3em !important; color: white !important; }

    .resaltado-cambio { background: #fff6b2 !important; transition: background 1.6s; }

    .table-responsive { overflow-x: auto; }
    .modal-content { border-radius: 12px; }

    .swal2-popup.swal2-responsive-popup {
      width: 350px !important;
      max-width: 95vw;
      font-size: 15px !important;
    }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
      will-change: opacity;
    }
    .loader.hidden{
      display:flex !important;
      opacity:0; pointer-events:none;
    }
    .spinner-ios{
      position:relative; width:64px; height:64px;
    }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{
      0%, 39%, 100% { opacity:.2; }
      40% { opacity:1; }
    }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    #contactosForm input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 1em;
      margin-bottom: 10px;
      margin-top: 1px;
    }
    .input-pass-group { position: relative; width: 100%; }
    .input-pass-group input { width: 100%; padding-right: 42px; }
    .input-pass-group .toggle-pass {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent;
      padding: 4px;
      cursor: pointer;
      line-height: 0;
      color: #007bff;
    }
    #contactosForm #btn-iniciar-sesion {
      display: block;
      width: max-content;
      margin: 8px auto 12px;
      padding: 10px 22px;
      font-weight: 800;
      font-size: 1.15rem;
      letter-spacing: .3px;
      border-radius: 8px;
    }
    .btn-center{
      display: flex;
      justify-content: center;
    }
    .btn-icon-db{
      background:transparent;
      border:0;
      padding:4px;
      margin-left:8px;
      vertical-align:middle;
      cursor:pointer;
      color:#c0392b;
    }
    .btn-icon-db svg{ width:16px; height:16px; display:inline-block; vertical-align:middle; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <!-- Formulario acceso -->
  <form id="contactosForm">
    <div class="titulo-contenedor">
      <h1 class="titulo-animado">INGRESO ADMINISTRADOR</h1>
    </div>
    <p>
      <b>Este Portal es de uso Exclusivo del Administrador.</b><br>
      <i>BALANCE DE REFERIDOS</i>
    </p>
    <label for="documento"><big><b>Clave de acceso:</b></big></label>
    <div class="input-pass-group">
      <input
        type="password"
        id="documento"
        name="documento"
        placeholder="Ingresa la clave"
        required
        autocomplete="off"
      />
      <button type="button" id="toggleDocumento" class="toggle-pass" aria-label="Mostrar/Ocultar clave" aria-controls="documento" aria-pressed="false" title="Mostrar/Ocultar">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
          <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/>
          <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/>
        </svg>
      </button>
    </div>
    <div id="errorMensaje" class="error"></div>
    <div class="btn-center">
      <button type="button" class="boton-efecto" id="btn-iniciar-sesion" onclick="validarDocumento()">
        Iniciar Sesión
      </button>
    </div>
    <div class="copyright">
      Copyright © <br>
      <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polanía</b></a>
    </div>
  </form>

  <!-- Contenedor tabla -->
  <main class="container mt-3" id="mainTableContainer" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:10px; margin-bottom: 0;">
      <div id="tituloLider"></div>
      <div style="display: flex; align-items: center;">
        <div class="header-right" style="display:flex; flex-direction:column; align-items:flex-end; margin-right:12px;">
          <div class="copyright" style="font-size:0.65em;">
            Copyright © <a href="https://wa.me/573103230712" target="_blank"><b>OSCAR POLANIA</b></a>
          </div>
          <button class="boton-efecto" id="btn-cerrar-sesion" onclick="cerrarSesion()" style="background:#C0392B; color:#fff; border-color:#C0392B;">Cerrar Sesión</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tablaReferidos" class="table table-striped responsive">
        <thead></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </main>

  <!-- Modal Votación -->
  <div class="modal fade" id="modalVotacion" tabindex="-1" aria-labelledby="modalVotacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formVotacion">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalVotacionLabel">Votación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div>
              <button type="button" class="boton-efecto" onclick="window.open('https://wsp.registraduria.gov.co/censo/consultar/', '_blank')">Ir a Consultar</button>
            </div>
            <label for="datos_row">Pega aquí los datos de la Registraduría:</label>
            <textarea class="form-control" id="datos_row" rows="4" placeholder="Pega aquí la info..." style="margin-bottom:10px;" required></textarea>

            <div class="row g-2">
              <div class="col-md-4"><input id="nuip" class="form-control" type="text" placeholder="NUIP" readonly></div>
              <div class="col-md-4"><input id="departamento" class="form-control" type="text" placeholder="DEPARTAMENTO" readonly></div>
              <div class="col-md-4"><input id="municipio" class="form-control" type="text" placeholder="MUNICIPIO" readonly></div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4"><input id="puesto" class="form-control" type="text" placeholder="PUESTO" readonly></div>
              <div class="col-md-4"><input id="direccion" class="form-control" type="text" placeholder="DIRECCIÓN" readonly></div>
              <div class="col-md-4"><input id="mesa" class="form-control" type="text" placeholder="MESA" readonly></div>
            </div>

            <div class="mt-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkALaEspera"
                       onchange="onEstadoCheckboxChange(this, 'A LA ESPERA')">
                <label class="form-check-label" for="chkALaEspera">
                  Marcar solo el MUNICIPIO como "A LA ESPERA"
                </label>
              </div>
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="chkPorConfirmar"
                       onchange="onEstadoCheckboxChange(this, 'POR CONFIRMAR')">
                <label class="form-check-label" for="chkPorConfirmar">
                  Marcar solo el MUNICIPIO como "POR CONFIRMAR"
                </label>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button id="btnGuardarVotacion" type="submit" class="boton-efecto">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal WhatsApp -->
  <div class="modal fade" id="modalWhatsapp" tabindex="-1" aria-labelledby="modalWhatsappLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formWhatsapp">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalWhatsappLabel">Enviar WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="mensajeWhatsapp">Mensaje:</label>
            <textarea class="form-control" id="mensajeWhatsapp" rows="4" placeholder="Escribe tu mensaje aquí"></textarea>
          </div>
          <div class="modal-footer">
            <button id="btnEnviarWhatsapp" type="submit" class="boton-efecto" style="background: #25D366; color:#fff; border-color:#25D366;">Enviar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzOZfjaBk5PF-0ytQ0pmE1EL4e8EzhLTAhURFjAqFMJbd3NJS1K1IHtpLgAzhxP09hv/exec';

    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }
    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
        loader.classList.add('hidden');
      }
    }

    async function apiGetTodasFilas() {
      startLoading();
      try {
        const body = new URLSearchParams({ action: 'getTodasFilas' });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiGuardarVotacion({ idxFila, nuip, departamento, municipio, puesto, direccion, mesa }) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'guardarVotacion',
          idxFila: idxFila != null ? String(idxFila) : '',
          nuip, departamento, municipio, puesto, direccion, mesa
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j;
      } finally { stopLoading(); }
    }
    async function apiEliminarFilas({ nuips }) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'eliminarFilas',
          nuips: JSON.stringify(nuips || [])
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'Error');
        return j;
      } finally { stopLoading(); }
    }

    let nombreLider = "ADMINISTRADOR";
    let filasFiltradas = [];
    let encabezados = [];
    let tabla;
    let documentoGuardado = "";
    let deleteMode = false;
    let selectedNuips = new Set();
    let filaVotacion = null;
    let filaWhatsapp = null;

    const columnasOcultas = ["CONTACTO", "REFERENCIA", "LIDER", "DEPARTAMENTO", "PUESTO", "DIRECCION", "MESA", "AÑO", "MES", "DIA"];

    async function validarDocumento() {
      const clave = document.getElementById('documento').value.trim();
      if (!clave){
        Swal.fire({ icon:'warning', title:'Clave requerida', text:'Ingresa la clave de acceso.', customClass:{popup:'swal2-responsive-popup'} });
        return;
      }
      if (clave !== '202402028'){
        Swal.fire({ icon:'error', title:'Clave incorrecta', text:'Verifica la clave e inténtalo de nuevo.', customClass:{popup:'swal2-responsive-popup'} });
        return;
      }

      playSoundOnce(SOUNDS.login);

      Swal.fire({
        title: 'Cargando datos...',
        html: 'Por favor espera unos segundos.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try {
        const res = await apiGetTodasFilas();
        Swal.close();

        encabezados = res.encabezados || [];
        filasFiltradas = Array.isArray(res.filas) ? res.filas : [];
        documentoGuardado = clave;
        nombreLider = 'ADMINISTRADOR';
        document.getElementById('tituloLider').textContent = 'Líder ADMINISTRADOR';

        if (!filasFiltradas.length){
          Swal.fire({
            icon: 'info',
            title: 'No hay registros',
            html: 'La hoja PRINCIPAL está vacía.',
            customClass:{popup:'swal2-responsive-popup'}
          });
          return;
        }

        ocultarFormulario();
        inicializarTabla();
      } catch (e){
        Swal.close();
        Swal.fire({ icon:'error', title:'Error', text:String(e), customClass:{popup:'swal2-responsive-popup'} });
      }
    }

    function mostrarFormulario() {
      document.getElementById('contactosForm').style.display = 'block';
      document.getElementById('mainTableContainer').style.display = 'none';
      document.getElementById('tituloLider').textContent = "";
    }
    function ocultarFormulario() {
      document.getElementById('contactosForm').style.display = 'none';
      document.getElementById('mainTableContainer').style.display = 'block';
    }
    function cerrarSesion() {
      playSoundOnce(SOUNDS.logout);
      nombreLider = "ADMINISTRADOR";
      filasFiltradas = [];
      encabezados = [];
      documentoGuardado = "";
      if (tabla) { tabla.destroy(); }
      mostrarFormulario();
      document.getElementById('documento').value = "";
    }

    function centrarEncabezadosTabla() {
      $('#tablaReferidos thead th, #tablaReferidos tfoot th')
        .removeClass('text-start text-left text-end text-right')
        .addClass('text-center')
        .css('text-align', 'center');
    }

    function inicializarTabla() {
      let colsDT = encabezados.map(header => ({ title: header }));
      colsDT.push({ title: "Votación" });
      colsDT.push({ title: "WhatsApp" });
      colsDT.push({ title: "Seleccionar" });

      $("#tablaReferidos thead").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");
      $("#tablaReferidos tfoot").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");

      let data = filasFiltradas.map(row => [...row, "", "", ""]).reverse();

      if ($.fn.DataTable.isDataTable('#tablaReferidos')) {
        $('#tablaReferidos').DataTable().destroy();
        $('#tablaReferidos').empty();
      }

      const ocultarIdxs = columnasOcultas
        .map(col => encabezados.indexOf(col))
        .filter(idx=>idx>-1);

      const colvisButton = { extend: 'colvis', text: 'Filtrar Columnas' };

      const adminExportButtons = [
        { extend: 'copy',  text: '<i class="bi bi-clipboard-fill"></i>', className: 'btn btn-secondary', exportOptions: { columns: ':visible' }, title: 'Referidos ' + nombreLider },
        { extend: 'excel', text: '<i class="bi bi-file-earmark-excel-fill"></i>', className: 'btn btn-success',  exportOptions: { columns: ':visible' }, filename: 'Referidos ' + nombreLider, title: 'Referidos ' + nombreLider },
        { extend: 'pdf',   text: '<i class="bi bi-file-earmark-pdf-fill"></i>',   className: 'btn btn-danger',   exportOptions: { columns: ':visible' }, filename: 'Referidos ' + nombreLider, title: 'Referidos ' + nombreLider },
        { extend: 'print', text: '<i class="bi bi-printer-fill"></i>',            className: 'btn btn-info',     exportOptions: { columns: ':visible' }, title: 'Referidos ' + nombreLider },
        colvisButton
      ];

      const idxVotacion = colsDT.length - 3;
      const idxWhatsapp = colsDT.length - 2;
      const idxSeleccion = colsDT.length - 1;

      const btnEliminar = {
        text: `Eliminar <span class="ms-1 align-middle"><i class="bi bi-file-earmark-minus-fill"></i></span>`,
        className: 'btn btn-outline-danger',
        attr: { id: 'btnEliminarFilas' },
        action: function(e, dt) {
          playSoundOnce(SOUNDS.warning);
          deleteMode = true;
          selectedNuips.clear();
          dt.column(idxSeleccion).visible(true);
          $('#btnEliminarFilas').addClass('d-none');
          $('#btnConfirmarEliminacion, #btnDescartarEliminacion').removeClass('d-none');
          Swal.fire({
            icon: 'warning',
            title: 'Modo eliminación',
            text: 'Selecciona una o varias filas para eliminar.',
            timer: 1800,
            showConfirmButton: false,
            customClass: { popup: 'swal2-responsive-popup' }
          });
        }
      };

      const btnConfirmar = {
        text: `Confirmar <span class="ms-1 align-middle"><i class="bi bi-trash-fill"></i></span>`,
        className: 'btn btn-danger d-none',
        attr: { id: 'btnConfirmarEliminacion' },
        action: async function(e, dt) {
          if (selectedNuips.size === 0) {
            Swal.fire({ icon: 'info', title: 'Sin selección', text: 'Selecciona al menos una fila.', customClass: { popup: 'swal2-responsive-popup' } });
            return;
          }
          const nuips = Array.from(selectedNuips);
          try {
            Swal.fire({ title: 'Eliminando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await apiEliminarFilas({ nuips });
            Swal.close();
            if (!res || res.ok !== true) throw new Error(res && res.error ? res.error : 'No se pudo eliminar');
            dt.rows(function(idx, data) {
              return nuips.includes(String((data && data[0]) || ''));
            }).remove().draw(false);
            exitDeleteMode(dt);
            playSoundOnce(SOUNDS.success);
            Swal.fire({
              icon: 'success',
              title: 'Fila o filas eliminadas',
              html: (res.eliminadas || 0) + ' fila(s) eliminada(s).',
              timer: 3000,
              showConfirmButton: false,
              customClass: { popup: 'swal2-responsive-popup' }
            });
          } catch (err) {
            Swal.fire({ icon: 'error', title: 'Error al eliminar', text: String(err), customClass: { popup: 'swal2-responsive-popup' } });
          }
        }
      };

      const btnDescartar = {
        text: `Descartar <span class="ms-1 align-middle"><i class="bi bi-x-square-fill"></i></span>`,
        className: 'btn btn-secondary d-none',
        attr: { id: 'btnDescartarEliminacion' },
        action: function(e, dt) {
          playSoundOnce(SOUNDS.back);
          exitDeleteMode(dt);
        }
      };

      const buttonsArr = [...adminExportButtons, btnEliminar, btnConfirmar, btnDescartar];

      tabla = $('#tablaReferidos').DataTable({
        language: { url: "//cdn.datatables.net/plug-ins/2.3.2/i18n/es-CO.json" },
        responsive: false,
        dom: 'Blfrtip',
        scrollX: true,
        autoWidth: true,
        pagingType: 'full_numbers',
        lengthMenu: [5, 10, 20, 50, 100],
        columns: colsDT,
        data: data,
        order: [],
        buttons: buttonsArr,
        columnDefs: [
          ...ocultarIdxs.map(idx => ({ targets: idx, visible: false })),
          {
            targets: idxVotacion,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              var idxMunicipio = encabezados.indexOf("MUNICIPIO");
              var municipio = "";
              if (idxMunicipio > -1) {
                municipio = (row[idxMunicipio] || "").toString().trim().toUpperCase();
              }
              var colorClass =
                municipio === "A LA ESPERA"   ? "gris"    :
                municipio === "POR CONFIRMAR" ? "naranja" :
                municipio === "SIN CONSULTAR" ? "azul"    :
                municipio === "FLANDES"       ? "verde"   : "";
              return `<button class="btn-votacion${colorClass ? ' ' + colorClass : ''}" data-row="${meta.row}" onclick="abrirModalVotacion(${meta.row})">Votación</button>`;
            }
          },
          {
            targets: idxWhatsapp,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const whatsappBtn = `<button class="btn-whatsapp" data-row="${meta.row}" onclick="abrirModalWhatsapp(${meta.row})"><i class="bi bi-whatsapp"></i></button>`;
              const copyIcon = `<button type="button" class="btn-icon-db" title="Copiar novedades" onclick="copiarFilaInfo(${meta.row})" aria-label="Copiar novedades">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database-fill-exclamation" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
        <path d="M8 1c-1.573 0-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4s.875 1.755 1.904 2.223C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777C13.125 5.755 14 5.007 14 4s-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1"/>
        <path d="M2 7v-.839c.457.432 1.004.751 1.49.972C4.722 7.693 6.318 8 8 8s3.278-.307 4.51-.867c.486-.22 1.033-.54 1.49-.972V7c0 .424-.155.802-.411 1.133a4.51 4.51 0 0 0-4.815 1.843A12 12 0 0 1 8 10c-1.573 0-3.022-.289-4.096-.777C2.875 8.755 2 8.007 2 7m6.257 3.998L8 11c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V10c0 1.007.875 1.755 1.904 2.223C4.978 12.711 6.427 13 8 13h.027a4.55 4.55 0 0 1 .23-2.002m-.002 3L8 14c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V13c0 1.007.875 1.755 1.904 2.223C4.978 15.711 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-1.3-1.905"/>
        <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-3.5-2a.5.5 0 0 0-.5.5v1.5a.5.5 0 0 0 1 0V11a.5.5 0 0 0-.5-.5m0 4a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
      </svg>
    </button>`;
              return whatsappBtn + copyIcon;
            }
          },
          {
            targets: idxSeleccion,
            orderable: false,
            searchable: false,
            visible: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const nuip = (row && row[0] != null) ? String(row[0]) : '';
              const checked = selectedNuips.has(nuip) ? 'checked' : '';
              return `<input type="checkbox" class="form-check-input row-select" data-nuip="${nuip}" ${checked} />`;
            }
          }
        ]
      });

      tabla.off('draw');
      tabla.on('draw', centrarEncabezadosTabla);
      centrarEncabezadosTabla();

      $('#tablaReferidos tbody').off('change', 'input.row-select');
      $('#tablaReferidos tbody').on('change', 'input.row-select', function() {
        const nuip = String(this.dataset.nuip || '');
        if (!nuip) return;
        if (this.checked) selectedNuips.add(nuip);
        else selectedNuips.delete(nuip);
      });

      function exitDeleteMode(dt) {
        deleteMode = false;
        selectedNuips.clear();
        dt.column(idxSeleccion).visible(false);
        $('#btnConfirmarEliminacion, #btnDescartarEliminacion').addClass('d-none');
        $('#btnEliminarFilas').removeClass('d-none');
      }
      window.exitDeleteMode = exitDeleteMode;
    }

    // === VOTACIÓN ===
    function onEstadoCheckboxChange(chk, estado){
      const inputMun = document.getElementById('municipio');
      if (!inputMun) return;

      const chkA = document.getElementById('chkALaEspera');
      const chkP = document.getElementById('chkPorConfirmar');
      const other = (estado === 'A LA ESPERA') ? chkP : chkA;

      if (chk.checked){
        if (other && other.checked) other.checked = false;
        if (inputMun.dataset.prevValue === undefined){
          inputMun.dataset.prevValue = inputMun.value || '';
        }
        inputMun.value = estado;
      } else {
        const algunoActivo = (chkA && chkA.checked) || (chkP && chkP.checked);
        if (!algunoActivo){
          if (inputMun.dataset.prevValue !== undefined){
            inputMun.value = inputMun.dataset.prevValue;
            delete inputMun.dataset.prevValue;
          }
        } else {
          inputMun.value = (chkP && chkP.checked) ? 'POR CONFIRMAR' : 'A LA ESPERA';
        }
      }
      updateDatosRowRequirement();
      setOnlyMunicipioModeUI(isEstadoCheckboxActive());
    }

    (function(){
      const modalEl = document.getElementById('modalVotacion');
      if (!modalEl) return;
      modalEl.addEventListener('show.bs.modal', function(){
        const chkA = document.getElementById('chkALaEspera');
        const chkP = document.getElementById('chkPorConfirmar');
        if (chkA) chkA.checked = false;
        if (chkP) chkP.checked = false;

        const inputMun = document.getElementById('municipio');
        if (inputMun && inputMun.dataset.prevValue !== undefined){
          delete inputMun.dataset.prevValue;
        }
        setOnlyMunicipioModeUI(false);
        updateDatosRowRequirement();
      });
    })();

    let ENCABEZADOS = ["NUIP", "DEPARTAMENTO", "MUNICIPIO", "PUESTO", "DIRECCIÓN", "MESA"];
    function limpiarYSeparar(texto) {
      let partes = texto.split(/[\t\n\r]+/).map(x => x.trim()).filter(x => x.length > 0);
      if (partes.length >= 6 && ENCABEZADOS.every(e => partes[0].toUpperCase().includes(e))) partes = partes.slice(1);
      if (partes.length >= 7 && ENCABEZADOS.every((e,i) => partes[i].toUpperCase() === e)) partes = partes.slice(6);
      partes = partes.filter(x => !ENCABEZADOS.includes(x.toUpperCase()));
      if (partes.length > 6) partes[5] = partes.slice(5).join(' ');
      if (partes.length > 6) partes = partes.slice(0,6);
      return partes;
    }
    function intentarAutocompletar() {
      const textarea = document.getElementById('datos_row');
      const pasted = textarea.value.trim();
      const partes = limpiarYSeparar(pasted);
      if (partes.length === 6) {
        document.getElementById('nuip').value = partes[0];
        document.getElementById('departamento').value = partes[1];
        document.getElementById('municipio').value = partes[2];
        document.getElementById('puesto').value = partes[3];
        document.getElementById('direccion').value = partes[4];
        document.getElementById('mesa').value = partes[5];
        textarea.readOnly = true;
      } else {
        textarea.readOnly = false;
      }
    }
    document.getElementById('datos_row').addEventListener('paste', function(e) { setTimeout(intentarAutocompletar, 100); });
    document.getElementById('datos_row').addEventListener('input', intentarAutocompletar);
    document.getElementById('datos_row').addEventListener('blur', intentarAutocompletar);

    function isEstadoCheckboxActive(){
      const chkA = document.getElementById('chkALaEspera');
      const chkP = document.getElementById('chkPorConfirmar');
      return (chkA && chkA.checked) || (chkP && chkP.checked);
    }

    function setOnlyMunicipioModeUI(on){
      const ta = document.getElementById('datos_row');
      if (ta){
        ta.required = !on;
        ta.readOnly = on;
        ta.disabled = on;
      }
      ['departamento','puesto','direccion','mesa'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.disabled = on;
      });
      const mun = document.getElementById('municipio');
      if (mun){ mun.disabled = false; }
    }

    function updateDatosRowRequirement(){
      const textarea = document.getElementById('datos_row');
      if (!textarea) return;
      const optional = isEstadoCheckboxActive();
      textarea.required = !optional;

      const label = document.querySelector('label[for="datos_row"]');
      if (label){
        if (!label.dataset.origText) label.dataset.origText = label.textContent;
        if (optional) {
          if (!/opcional/i.test(label.textContent)) {
            label.textContent = label.dataset.origText + ' (opcional)';
          }
        } else {
          label.textContent = label.dataset.origText;
        }
      }
    }

    function abrirModalVotacion(idxFila) {
      filaVotacion = idxFila;

      try {
        const row0 = tabla.row(idxFila).data();
        if (row0 && row0[0] && navigator.clipboard) {
          navigator.clipboard.writeText(String(row0[0])).catch(()=>{});
        }
      } catch(e){}

      document.getElementById('datos_row').value = "";
      document.getElementById('nuip').value = "";
      document.getElementById('departamento').value = "";
      document.getElementById('municipio').value = "";
      document.getElementById('puesto').value = "";
      document.getElementById('direccion').value = "";
      document.getElementById('mesa').value = "";

      const row = tabla.row(idxFila).data();

      const idxByHeader = (...cands) => {
        for (const c of cands) {
          if (!c) continue;
          const i = encabezados.indexOf(c);
          if (i > -1) return i;
        }
        return -1;
      };
      const firstValid = (...idxs) => {
        for (const i of idxs) if (i > -1) return i;
        return -1;
      };

      const iDeptoByName = idxByHeader('DEPARTAMENTO','Depto','DEPARTAMENTO/DPTO');
      const iMunByName   = idxByHeader('MUNICIPIO','MUNICIPIO/MCPIO');
      const iPueByName   = idxByHeader('PUESTO','PUESTO DE VOTACIÓN');
      const iDirByName   = idxByHeader('DIRECCION','DIRECCIÓN');
      const iMesaByName  = idxByHeader('MESA');

      const iH = idxByHeader('H');
      const iI = idxByHeader('I');
      const iJ = idxByHeader('J');
      const iK = idxByHeader('K');
      const iL = idxByHeader('L');

      const iDepto = firstValid(iDeptoByName, iH);
      const iMun   = firstValid(iMunByName,   iI);
      const iPue   = firstValid(iPueByName,   iJ);
      const iDir   = firstValid(iDirByName,   iK);
      const iMesa  = firstValid(iMesaByName,  iL);

      document.getElementById('nuip').value = (row && row[0] != null) ? String(row[0]) : "";

      const dep = (iDepto > -1 && row[iDepto]) ? String(row[iDepto]) : '';
      const mun = (iMun   > -1 && row[iMun])   ? String(row[iMun])   : '';
      const pue = (iPue   > -1 && row[iPue])   ? String(row[iPue])   : '';
      const dir = (iDir   > -1 && row[iDir])   ? String(row[iDir])   : '';
      const mes = (iMesa  > -1 && row[iMesa])  ? String(row[iMesa])  : '';

      const tienePrevios = [dep, mun, pue, dir, mes].some(v => v.trim().length > 0);

      if (tienePrevios) {
        document.getElementById('departamento').value = dep;
        document.getElementById('municipio').value    = mun;
        document.getElementById('puesto').value       = pue;
        document.getElementById('direccion').value    = dir;
        document.getElementById('mesa').value         = mes;
        document.getElementById('btnGuardarVotacion').textContent = "Actualizar";
      } else {
        document.getElementById('btnGuardarVotacion').textContent = "Guardar";
      }
      new bootstrap.Modal(document.getElementById('modalVotacion')).show();
    }

    document.getElementById('formVotacion').addEventListener('submit', async function(e){
      e.preventDefault();

      const nuip = document.getElementById('nuip').value.trim();
      let departamento = document.getElementById('departamento').value.trim();
      let municipio    = document.getElementById('municipio').value.trim();
      let puesto       = document.getElementById('puesto').value.trim();
      let direccion    = document.getElementById('direccion').value.trim();
      let mesa         = document.getElementById('mesa').value.trim();

      const onlyMunicipioMode = isEstadoCheckboxActive();

      if (onlyMunicipioMode){
        if (!nuip || !municipio){
          Swal.fire({icon:'warning',title:'Completa los campos requeridos',text:'NUIP y MUNICIPIO son obligatorios cuando marcas el estado.'});
          return;
        }

        const row = tabla.row(filaVotacion).data() || [];

        const idxByHeader = (...cands) => {
          for (const c of cands) {
            if (!c) continue;
            const i = encabezados.indexOf(c);
            if (i > -1) return i;
          }
          return -1;
        };
        const firstValid = (...idxs) => { for (const i of idxs) if (i > -1) return i; return -1; };

        const iDepto = firstValid(idxByHeader('DEPARTAMENTO','Depto','DEPARTAMENTO/DPTO'), idxByHeader('H'));
        const iMun   = firstValid(idxByHeader('MUNICIPIO','MUNICIPIO/MCPIO'),           idxByHeader('I'));
        const iPue   = firstValid(idxByHeader('PUESTO','PUESTO DE VOTACIÓN'),           idxByHeader('J'));
        const iDir   = firstValid(idxByHeader('DIRECCION','DIRECCIÓN'),                 idxByHeader('K'));
        const iMesa  = firstValid(idxByHeader('MESA'),                                  idxByHeader('L'));

        if (!departamento && iDepto > -1) departamento = String(row[iDepto] || '');
        if (!puesto       && iPue   > -1) puesto       = String(row[iPue]   || '');
        if (!direccion    && iDir   > -1) direccion    = String(row[iDir]   || '');
        if (!mesa         && iMesa  > -1) mesa         = String(row[iMesa]  || '');
      } else {
        if(!nuip || !departamento || !municipio || !puesto || !direccion || !mesa){
          Swal.fire({icon:'warning',title:'Completa todos los campos',text:'Verifica que la información esté completa.'});
          return;
        }
      }

      try {
        const res = await apiGuardarVotacion({
          idxFila: filaVotacion,
          nuip,
          departamento,
          municipio,
          puesto,
          direccion,
          mesa
        });
        if (!res || res.ok !== true) throw new Error(res && res.error ? res.error : 'No se pudo guardar');

        const idxByHeader = (...cands) => {
          for (const c of cands) {
            if (!c) continue;
            const i = encabezados.indexOf(c);
            if (i > -1) return i;
          }
          return -1;
        };
        const firstValid = (...idxs) => { for (const i of idxs) if (i > -1) return i; return -1; };

        const iDepto = firstValid(idxByHeader('DEPARTAMENTO','Depto','DEPARTAMENTO/DPTO'), idxByHeader('H'));
        const iMun   = firstValid(idxByHeader('MUNICIPIO','MUNICIPIO/MCPIO'),           idxByHeader('I'));
        const iPue   = firstValid(idxByHeader('PUESTO','PUESTO DE VOTACIÓN'),           idxByHeader('J'));
        const iDir   = firstValid(idxByHeader('DIRECCION','DIRECCIÓN'),                 idxByHeader('K'));
        const iMesa  = firstValid(idxByHeader('MESA'),                                  idxByHeader('L'));

        let nuevaFila = tabla.row(filaVotacion).data().slice();
        if (iDepto > -1) nuevaFila[iDepto] = departamento;
        if (iMun   > -1) nuevaFila[iMun]   = municipio;
        if (iPue   > -1) nuevaFila[iPue]   = puesto;
        if (iDir   > -1) nuevaFila[iDir]   = direccion;
        if (iMesa  > -1) nuevaFila[iMesa]  = mesa;

        tabla.row(filaVotacion).data(nuevaFila).invalidate().draw(false);

        const tr = tabla.row(filaVotacion).node();
        [iDepto,iMun,iPue,iDir,iMesa].forEach(i=>{
          if (i > -1 && tr && tr.children[i]) {
            tr.children[i].classList.add('resaltado-cambio');
            setTimeout(()=>{ tr.children[i].classList.remove('resaltado-cambio'); }, 2000);
          }
        });

        bootstrap.Modal.getInstance(document.getElementById('modalVotacion')).hide();
        Swal.fire({
          icon: 'success',
          title: '¡Datos actualizados!',
          html: (onlyMunicipioMode
            ? 'Se actualizó únicamente el <b>MUNICIPIO</b>.'
            : 'Los datos se guardaron correctamente.'
          ),
          timer: 3500,
          showConfirmButton: false
        });
      } catch (err) {
        Swal.fire({ icon:'error', title:'Error al guardar', text:String(err) });
      }
    });

    // === WHATSAPP ===
    function abrirModalWhatsapp(idxFila) {
      filaWhatsapp = idxFila;
      document.getElementById('mensajeWhatsapp').value = "";
      new bootstrap.Modal(document.getElementById('modalWhatsapp')).show();
    }

    document.getElementById('formWhatsapp').addEventListener('submit', function(e){
      e.preventDefault();
      const mensaje = document.getElementById('mensajeWhatsapp').value.trim();
      const rowData = tabla.row(filaWhatsapp).data();
      let numero = (rowData[2] || '').replace(/\D/g, '');
      if (!numero) {
        Swal.fire({icon:'error',title:'No hay número de WhatsApp disponible en la fila'});
        return;
      }
      if (navigator.clipboard && mensaje) { navigator.clipboard.writeText(mensaje).catch(()=>{}); }
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      var whatsappUrl = isMobile
        ? ('whatsapp://send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje))
        : ('https://api.whatsapp.com/send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje));
      window.open(whatsappUrl, "_blank");
      bootstrap.Modal.getInstance(document.getElementById('modalWhatsapp')).hide();
    });

    function copiarFilaInfo(idxFila){
      try {
        const row = tabla.row(idxFila).data() || [];
        const findIdx = nameCandidates => {
          for (const cand of nameCandidates){
            const i = encabezados.findIndex(h => String(h || '').trim().toUpperCase() === cand.toUpperCase());
            if (i > -1) return i;
          }
          return -1;
        };
        const idxNombre = findIdx(['NOMBRE','NOMBRE COMPLETO','NOMBRE Y APELLIDO']);
        const idxDocumento = findIdx(['DOCUMENTO','CC','NUIP']);
        const idxLider = findIdx(['LIDER','LÍDER']);
        const idxMunicipio = findIdx(['MUNICIPIO','MUNI','MUNICIPIO/MCPIO']);

        const nombre = (idxNombre > -1 ? String(row[idxNombre] || '') : '');
        const documento = (idxDocumento > -1 ? String(row[idxDocumento] || '') : '');
        const lider = (idxLider > -1 ? String(row[idxLider] || '') : nombreLider || '');
        const municipio = (idxMunicipio > -1 ? String(row[idxMunicipio] || '') : '');

        const texto =
`*NOMBRE:* ${nombre}
*CC:* ${documento}
*LIDER:* ${lider}
*ESTADO:* ${municipio}

*NOVEDAD:* `;

        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(texto).then(()=>{
            playSoundOnce(SOUNDS.success);
            Swal.fire({ icon: 'success', title: 'Copiado', text: 'Información copiada al portapapeles', timer: 1400, showConfirmButton: false, toast: true, position: 'top-end' });
          }).catch(err=>{
            const ta = document.createElement('textarea');
            ta.value = texto;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); playSoundOnce(SOUNDS.success); } catch(e){}
            document.body.removeChild(ta);
            Swal.fire({ icon: 'success', title: 'Copiado', text: 'Información copiada al portapapeles', timer: 1400, showConfirmButton: false, toast: true, position: 'top-end' });
          });
        } else {
          const ta = document.createElement('textarea');
          ta.value = texto;
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); playSoundOnce(SOUNDS.success); } catch(e){}
          document.body.removeChild(ta);
          Swal.fire({ icon: 'success', title: 'Copiado', text: 'Información copiada al portapapeles', timer: 1400, showConfirmButton: false, toast: true, position: 'top-end' });
        }
      } catch(err){
        Swal.fire({ icon: 'error', title: 'Error', text: String(err) });
      }
    }

    (function(){
      const input = document.getElementById('documento');
      const btn = document.getElementById('toggleDocumento');
      const ICON_EYE_SLASH = btn.innerHTML;
      const ICON_EYE = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg>';
      if (input && btn){
        btn.addEventListener('click', function(){
          const willShow = input.type === 'password';
          input.type = willShow ? 'text' : 'password';
          btn.setAttribute('aria-pressed', String(willShow));
          btn.innerHTML = willShow ? ICON_EYE : ICON_EYE_SLASH;
          try {
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
          } catch(e){}
        });
      }
    })();

    document.getElementById('btn-iniciar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.login));
    document.getElementById('btn-cerrar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.logout));
  </script>
</body>
</html>
